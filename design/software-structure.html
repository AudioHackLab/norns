<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>norns - software architecture</title>
<!-- 2017-01-24 Tue 18:33 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">norns - software architecture</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. about this document</a>
<ul>
<li><a href="#sec-1-1">1.1. history</a></li>
<li><a href="#sec-1-2">1.2. intent</a></li>
</ul>
</li>
<li><a href="#sec-2">2. overview of functionality.</a>
<ul>
<li><a href="#sec-2-1">2.1. <b>maiden</b></a></li>
<li><a href="#sec-2-2">2.2. <b>matron</b></a></li>
<li><a href="#sec-2-3">2.3. <b>crone</b></a></li>
</ul>
</li>
<li><a href="#sec-3">3. software architecture</a></li>
<li><a href="#sec-4">4. implementation notes</a>
<ul>
<li><a href="#sec-4-1">4.1. IPC</a></li>
<li><a href="#sec-4-2">4.2. audio buffers</a></li>
<li><a href="#sec-4-3">4.3. MIDI</a></li>
<li><a href="#sec-4-4">4.4. timing resolution</a></li>
<li><a href="#sec-4-5">4.5. HID</a></li>
</ul>
</li>
<li><a href="#sec-5">5. next steps</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> about this document</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> history</h3>
<div class="outline-text-3" id="text-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">version</th>
<th scope="col" class="right">date</th>
<th scope="col" class="left">author</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">0.0.0</td>
<td class="right">2017-01-22</td>
<td class="left">emb</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> intent</h3>
<div class="outline-text-3" id="text-1-2">
<p>
this document proposes a preliminary high-level software design for <b>norns</b>. its goal is to outline a broad plan for code module separation and identify some of the 3rd-party technologies to use. we do not expect every implementation choice to remain unchanged.
</p>

<p>
this document can be updated to reflect architecture changes as we approach version 1.0.0.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> overview of functionality.</h2>
<div class="outline-text-2" id="text-2">
<p>
<b>norns</b> is an audio processing hardware and software package, built on raspberry pi and linux.
</p>


<p>
primary features of <b>norns</b>:
</p>

<ul class="org-ul">
<li>provide the user with an interpreted programming environment (Lua) for soft-realtime control of audio processing
</li>

<li>enable remote execution of user code on the fly
</li>

<li>change/reroute audio modules on the fly
</li>

<li>provide an "easy" path to development of new audio modules
</li>

<li>integrate with a wide variety of controller hardware
</li>
</ul>

<p>
functionality is divided into three main areas, which may or may not correspond to separate processes/applications, but which shall certainly be implemented as distinct code modules.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> <b>maiden</b></h3>
<div class="outline-text-3" id="text-2-1">
<p>
controller: provides the user interface, chooses user code to be executed, and communicates with remote hosts. 
</p>

<p>
initially, it will provide a text-only interface for terminal access using <code>ncurses</code>. 
</p>

<p>
future iterations could do other things:
</p>
<ul class="org-ul">
<li>serve a web app via HTTP
</li>
<li>provide a REST API over HTTP for a client side app
</li>
<li>something else?
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> <b>matron</b></h3>
<div class="outline-text-3" id="text-2-2">
<p>
interpreter: maintains Lua state, executes user code, and glues the interpreted environment to everything else:
</p>
<ul class="org-ul">
<li>input from <b>maiden</b>  (user code, but maybe other things too
</li>
<li>output to <b>crone</b>  (change audio modules, parameters, buffers, &amp;c)
</li>
<li>I/O to and from onboard hardware (encoders, switches, screen)
</li>
<li>I/O to and from USB peripherals (grids, MIDI, HID)
</li>
<li>other hardware? (i2c? serial?)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> <b>crone</b></h3>
<div class="outline-text-3" id="text-2-3">
<p>
audio host.
</p>
<ul class="org-ul">
<li>swaps audio 'modules' ('instruments'? 'engines'?)
</li>
<li>manipulates processing parameters
</li>
<li>loads and stores sound files
</li>
<li>can receive and transmit audio buffer data

<p>
the initial implementation will be in Supercollider and communicate with <b>matron</b> using OSC.
</p>

<p>
for future iterations, we are considering implementing an <a href="http://lv2plug.in">LV2</a> host, likely based on the <a href="https://github.com/moddevices/mod-host">MOD devices</a> codebase. 
</p>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> software architecture</h2>
<div class="outline-text-2" id="text-3">
<p>
here is an informal flowchart / code module layout. it does not mean to describe data or dependency flow in detail, only to suggest technologies, libraries, project structure and tasks required for a working prototype.
</p>


<div class="figure">
<p><img src="norns_structure_legend.svg" alt="norns_structure_legend.svg" />
</p>
</div>


<div class="figure">
<p><img src="norns_structure.svg" alt="norns_structure.svg" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> implementation notes</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> IPC</h3>
<div class="outline-text-3" id="text-4-1">
<p>
in the figure above, the header files <code>oracle.h</code> and <code>weaver.h</code> are referenced. this is just to emphasise that each channel of interprocess communication should be handled through a "black box" API. 
</p>

<p>
for example: here we specify the use of shared memory between controller and interpreter, but in the final implementation we may want to allow <b>maiden</b> to run remotely, making serial communication a better choice. 
</p>

<p>
so, these dedicated headers will specify interprocess <i>protocols</i>, while keeping the transport layer decoupled. it would be great to generate them directly from a protocol spec.
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> audio buffers</h3>
<div class="outline-text-3" id="text-4-2">
<p>
one requested feature is the ability to manipulate audio buffers from user code. ideally, this feature would be implemented using shared memory between interpreter and processor; in practice, this may prove challenging. it may be possible to used shared memory between an LV2 host and its plugins, but for supercollider such an exchange can only be acheived asynchronously with a sequence of OSC packets (or by considerable hacking on the scsynth codebase.)
</p>

<p>
in any case, direct transmission of audio buffer data will be part of the API described by <code>oracle.h</code>, as well as functions to move audio between <b>crone</b> and the filesystem. 
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> MIDI</h3>
<div class="outline-text-3" id="text-4-3">
<p>
it's not yet clear how we should pass MIDI through the interpreter. it may be impossible to provide sample-accurate events in that circumstance. we could do one or more of the following:
</p>
<ul class="org-ul">
<li><b>matron</b> interacts directly with e.g. <code>/dev/sequencer</code>. fine for coarse time resolution / sparse events.
</li>
<li><b>matron</b> registers as an ALSA or JACK client and receives MIDI event buffers.
</li>
<li>user code can pass MIDI handling over to the audio server somehow (and define logic/transformation? hm), allowing sample-accurate performance.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> timing resolution</h3>
<div class="outline-text-3" id="text-4-4">
<p>
as the above section implies, there is some uncertainty about how close to "realtime" the interpreted code can get. (to diagnose this, implementing glue between Lua and (say) POSIX timers should be an early order of business.)
</p>

<p>
but with Supercollider as the engine, we are inherently limited to the sample block rate, as far as how often parameter changes are interpreted. in addition, the OSC/UDP connection has limited bandwidth (but maybe enough to make no significant difference, except for arbitrarily large buffer transactions.)
</p>

<p>
if we do end up switching to LV2, we can use shared memory (greater bandwidth), and even schedule timestamped events within a sample block.
</p>
</div>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> HID</h3>
<div class="outline-text-3" id="text-4-5">
<p>
there are a number of competing solutions for getting input from HID devices such as gamepads. <code>libevdev</code> is a contemporary alternative to <code>libudev</code> for getting low-level events. but initially we might use a higher-level library like <code>SDL2</code>, just to take some of the pain out of device management. 
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> next steps</h2>
<div class="outline-text-2" id="text-5">
<p>
this document does not describe:
</p>

<ul class="org-ul">
<li>specific features and API for <b>crone</b> 
</li>

<li>specific features and API for <b>matron</b>
</li>

<li>UI design for <b>maiden</b>
</li>
</ul>

<p>
these topics should be addressed separately, and relatively soon. for the moment we can assume some basic, obvious features, and begin implementation with those&#x2026;
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2017-01-24 Tue 18:33</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
